// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// Admin users for the newsletter service
model User {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  email         String    @unique
  emailVerified DateTime?
  password      String // hashed password
  name          String?
  role          UserRole  @default(ADMIN)

  accounts Account[]
  sessions Session[]

  // Relations
  newsletters Newsletter[]
  templates   EmailTemplate[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

enum UserRole {
  ADMIN
  EDITOR
  VIEWER
}

model Account {
  id                String  @id @default(auto()) @map("_id") @db.ObjectId
  userId            String  @db.ObjectId
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.String
  access_token      String? @db.String
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.String
  session_state     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken String   @unique
  userId       String   @db.ObjectId
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VerificationToken {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
}

// Email subscribers
model Subscriber {
  id     String           @id @default(auto()) @map("_id") @db.ObjectId
  email  String           @unique
  name   String?
  status SubscriberStatus @default(PENDING)
  tags   String[]         @default([])

  // Preferences
  subscribedAt   DateTime?
  confirmedAt    DateTime?
  unsubscribedAt DateTime?
  lastOpenedAt   DateTime?
  lastClickedAt  DateTime?

  // Engagement metrics
  openCount      Int @default(0)
  clickCount     Int @default(0)
  bounceCount    Int @default(0)
  complaintCount Int @default(0)

  // Relations
  emailLogs   EmailLog[]
  preferences SubscriberPreference?

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  unsubscribeLogs UnsubscribeLog[]

  @@map("subscribers")
}

enum Frequency {
  DAILY
  WEEKLY
  MONTHLY
  REALTIME
}

enum SubscriberStatus {
  PENDING
  CONFIRMED
  UNSUBSCRIBED
  BOUNCED
}

// Subscriber preferences
model SubscriberPreference {
  id           String     @id @default(auto()) @map("_id") @db.ObjectId
  subscriberId String     @unique @db.ObjectId
  subscriber   Subscriber @relation(fields: [subscriberId], references: [id], onDelete: Cascade)

  frequency  SubscriberPreferenceFrequency @default(DAILY)
  categories String[]                      @default([])
  noEmails   Boolean                       @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("subscriber_preferences")
}

enum SubscriberPreferenceFrequency {
  DAILY
  WEEKLY
  MONTHLY
  REALTIME
}

// Email newsletters/campaigns
model Newsletter {
  id      String           @id @default(auto()) @map("_id") @db.ObjectId
  title   String
  subject String
  content String
  preview String?
  status  NewsletterStatus @default(DRAFT)

  // Scheduling
  scheduledFor DateTime?
  sentAt       DateTime?

  // Audience
  audienceTags   String[] @default([])
  recipientCount Int      @default(0)

  // Performance
  openCount   Int @default(0)
  clickCount  Int @default(0)
  bounceCount Int @default(0)

  // Relations - Make author required
  authorId   String?        @db.ObjectId
  author     User?          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  templateId String?        @db.ObjectId
  template   EmailTemplate? @relation(fields: [templateId], references: [id])
  emailLogs  EmailLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("newsletters")
}

enum NewsletterStatus {
  DRAFT
  SCHEDULED
  SENDING
  SENT
  FAILED
}

// Email templates for reusable newsletter designs
model EmailTemplate {
  id       String  @id @default(auto()) @map("_id") @db.ObjectId
  name     String  @unique
  subject  String
  content  String // HTML content
  preview  String?
  category String  @default("general")

  // Relations - Make author optional to support system templates
  authorId    String?      @db.ObjectId
  author      User?        @relation(fields: [authorId], references: [id])
  newsletters Newsletter[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("email_templates")
}

// Email sending logs for tracking
model EmailLog {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  messageId String? // ID from email provider

  // Recipients and content
  recipientEmail String
  subscriberId   String     @db.ObjectId
  subscriber     Subscriber @relation(fields: [subscriberId], references: [id], onDelete: Cascade)

  newsletterId String     @db.ObjectId
  newsletter   Newsletter @relation(fields: [newsletterId], references: [id], onDelete: Cascade)

  // Status tracking
  status       EmailLogStatus @default(PENDING)
  statusReason String?

  // Engagement
  openedAt     DateTime?
  clickedAt    DateTime?
  bouncedAt    DateTime?
  complainedAt DateTime?

  // Retry info
  retryCount Int       @default(0)
  lastRetry  DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("email_logs")
}

enum EmailLogStatus {
  PENDING
  SENT
  DELIVERED
  OPENED
  CLICKED
  BOUNCED
  COMPLAINED
  FAILED
}

// Campaign segments for targeting
model CampaignSegment {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String   @unique
  description String?
  tags        String[] // Tags that define this segment

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("campaign_segments")
}

// Unsubscribe log for compliance
// Unsubscribe log for compliance
model UnsubscribeLog {
  id             String   @id @default(auto()) @map("_id") @db.ObjectId
  email          String
  reason         String?
  unsubscribedAt DateTime @default(now())

  // Add relationship to Subscriber
  subscriberId String?     @db.ObjectId
  subscriber   Subscriber? @relation(fields: [subscriberId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@map("unsubscribe_logs")
}
